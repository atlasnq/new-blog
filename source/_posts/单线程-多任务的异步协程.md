---
title: å•çº¿ç¨‹-å¤šä»»åŠ¡çš„å¼‚æ­¥åç¨‹
copyright: true
date: 2019-09-23 09:49:37
tags: [ç½‘ç»œçˆ¬è™«,python,å¹¶å‘ç¼–ç¨‹,å­¦ä¹ ç¬”è®°]
categories: ç½‘ç»œçˆ¬è™«
comments: true
urlname:  Web_Spider_4
---



{% cq %}æœ¬ç¯‡ä»‹ç»åŸºäºasyncioæ¨¡å—ï¼Œå®ç°å•çº¿ç¨‹-å¤šä»»åŠ¡çš„å¼‚æ­¥åç¨‹ã€‚ {% endcq %}

<!--more-->



# åŸºæœ¬æ¦‚å¿µ

>  	åç¨‹æ˜¯å®ç°å¹¶å‘ç¼–ç¨‹çš„ä¸€ç§æ–¹å¼ã€‚ä¸€è¯´å¹¶å‘ï¼Œä½ è‚¯å®šæƒ³åˆ°äº†å¤šçº¿ç¨‹ / å¤šè¿›ç¨‹æ¨¡å‹ï¼Œæ²¡é”™ï¼Œå¤šçº¿ç¨‹ / å¤šè¿›ç¨‹ï¼Œæ­£æ˜¯è§£å†³å¹¶å‘é—®é¢˜çš„ç»å…¸æ¨¡å‹ä¹‹ä¸€ã€‚æœ€åˆçš„äº’è”ç½‘ä¸–ç•Œï¼Œå¤šçº¿ç¨‹ / å¤šè¿›ç¨‹åœ¨æœåŠ¡å™¨å¹¶å‘ä¸­ï¼Œèµ·åˆ°ä¸¾è¶³è½»é‡çš„ä½œç”¨ã€‚
>
> â€‹	éšç€äº’è”ç½‘çš„å¿«é€Ÿå‘å±•ï¼Œä½ é€æ¸é‡åˆ°äº† **C10K ç“¶é¢ˆ**ï¼Œä¹Ÿå°±æ˜¯åŒæ—¶è¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·è¾¾åˆ°äº†ä¸€ä¸‡ä¸ªã€‚äºæ˜¯å¾ˆå¤šä»£ç è·‘å´©äº†ï¼Œè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å ç”¨äº†å¤§é‡çš„èµ„æºï¼Œçº¿ç¨‹ä¹Ÿé¡¶ä¸ä½å¦‚æ­¤å·¨å¤§çš„å‹åŠ›ï¼Œè¿™æ—¶ï¼Œ NGINX å¸¦ç€**äº‹ä»¶å¾ªç¯**å‡ºæ¥æ‹¯æ•‘ä¸–ç•Œäº†ã€‚
>
> â€‹	å¦‚æœå°†å¤šè¿›ç¨‹ / å¤šçº¿ç¨‹ç±»æ¯”ä¸ºèµ·æºäºå”æœçš„è—©é•‡å‰²æ®ï¼Œé‚£ä¹ˆäº‹ä»¶å¾ªç¯ï¼Œå°±æ˜¯å®‹æœåŠ å¼ºçš„ä¸­å¤®é›†æƒåˆ¶ã€‚**äº‹ä»¶å¾ªç¯å¯åŠ¨ä¸€ä¸ªç»Ÿä¸€çš„è°ƒåº¦å™¨ï¼Œè®©è°ƒåº¦å™¨æ¥å†³å®šä¸€ä¸ªæ—¶åˆ»å»è¿è¡Œå“ªä¸ªä»»åŠ¡ï¼Œäºæ˜¯çœå´äº†å¤šçº¿ç¨‹ä¸­å¯åŠ¨çº¿ç¨‹ã€ç®¡ç†çº¿ç¨‹ã€åŒæ­¥é”ç­‰å„ç§å¼€é”€ã€‚**åŒä¸€æ—¶æœŸçš„ NGINXï¼Œåœ¨é«˜å¹¶å‘ä¸‹èƒ½ä¿æŒä½èµ„æºä½æ¶ˆè€—é«˜æ€§èƒ½ï¼Œç›¸æ¯” Apache ä¹Ÿæ”¯æŒæ›´å¤šçš„å¹¶å‘è¿æ¥ã€‚
>
> â€‹	å†åˆ°åæ¥ï¼Œå‡ºç°äº†ä¸€ä¸ªå¾ˆæœ‰åçš„åè¯ï¼Œå«åšå›è°ƒåœ°ç‹±ï¼ˆcallback hellï¼‰ï¼Œæ‰‹æ’¸è¿‡ JavaScript çš„æœ‹å‹è‚¯å®šçŸ¥é“æˆ‘åœ¨è¯´ä»€ä¹ˆã€‚æˆ‘ä»¬å¤§å®¶æƒŠå–œåœ°å‘ç°ï¼Œè¿™ç§å·¥å…·å®Œç¾åœ°ç»§æ‰¿äº†äº‹ä»¶å¾ªç¯çš„ä¼˜è¶Šæ€§ï¼ŒåŒæ—¶è¿˜èƒ½æä¾› async / await è¯­æ³•ç³–ï¼Œè§£å†³äº†æ‰§è¡Œæ€§å’Œå¯è¯»æ€§å…±å­˜çš„éš¾é¢˜ã€‚äºæ˜¯ï¼Œåç¨‹é€æ¸è¢«æ›´å¤šäººå‘ç°å¹¶çœ‹å¥½ï¼Œä¹Ÿæœ‰è¶Šæ¥è¶Šå¤šçš„äººå°è¯•ç”¨ Node.js åšèµ·äº†åç«¯å¼€å‘ã€‚ï¼ˆè®²ä¸ªç¬‘è¯ï¼ŒJavaScript æ˜¯ä¸€é—¨ç¼–ç¨‹è¯­è¨€ã€‚ï¼‰
>
> å¼•ç”¨è‡ªã€ŠPythonæ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜ã€‹



## åç¨‹å‡½æ•°

- *åç¨‹å‡½æ•°*: å®šä¹‰å½¢å¼ä¸º [`async def`](https://docs.python.org/zh-cn/3/reference/compound_stmts.html#async-def) çš„å‡½æ•°;

### aysnc

- åœ¨`Python`3.5+ç‰ˆæœ¬æ–°å¢äº†`aysnc`å’Œ`await`å…³é”®å­—ï¼Œè¿™ä¸¤ä¸ªè¯­æ³•ç³–è®©æˆ‘ä»¬éå¸¸æ–¹ä¾¿åœ°å®šä¹‰å’Œä½¿ç”¨åç¨‹ã€‚

- å¦‚æœä¸€ä¸ªå‡½æ•°çš„å®šä¹‰è¢«`async`ä¿®é¥°åï¼Œåˆ™è¯¥å‡½æ•°å°±æ˜¯ä¸€ä¸ª**ç‰¹æ®Šçš„å‡½æ•°ï¼ˆåç¨‹å‡½æ•°ï¼‰**ã€‚

```python
# ä½¿ç”¨ async å…³é”®å­—ä¿®é¥°å‡½æ•°åï¼Œè°ƒç”¨è¯¥å‡½æ•°ï¼Œä½†ä¸ä¼šæ‰§è¡Œå‡½æ•°ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªcoroutineåç¨‹å¯¹è±¡
async def get_request(url):
    print("æ­£åœ¨è¯·æ±‚: ", url)
    sleep(1)
    print('è¯·æ±‚ç»“æŸ:', url)
    
get_request('www.b.com')	
```

è¿è¡Œåˆ†æï¼š

- ç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„è¯å¹¶ä¸ä¼šè¢«æ‰§è¡Œï¼Œä¹Ÿä¼šå‡ºç°ä¸€æ¡è­¦å‘Š `RuntimeWarning: coroutine 'get_request' was never awaited` ã€‚

- å¯¹äºå®ƒçš„è§£é‡Š [å®˜æ–¹æ–‡æ¡£](https://docs.python.org/zh-cn/3/library/asyncio-dev.html) é‡Œæåˆ°ï¼Œå½“åç¨‹ç¨‹åºè¢«è°ƒç”¨è€Œä¸æ˜¯è¢«ç­‰å¾…æ—¶ï¼ˆå³æ‰§è¡Œ `get_request('www.b.com')` è€Œä¸æ˜¯  `await get_request('www.b.com')` ï¼‰æˆ–è€…åç¨‹æ²¡æœ‰é€šè¿‡ [`asyncio.create_task()`](https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.create_task) è¢«æ’å…¥è®¡åˆ’æ—¥ç¨‹ï¼ˆ**åˆ›å»ºä»»åŠ¡å¯¹è±¡**ï¼‰ï¼Œasyncio å°†ä¼šå‘å‡ºä¸€æ¡ [`RuntimeWarning`](https://docs.python.org/zh-cn/3/library/exceptions.html#RuntimeWarning)ã€‚

- å½“ç„¶ asyncio.create_task( get_request)  æ˜¯py3.7ä¸­çš„ï¼Œåœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­æ˜¯ç”¨åˆ°çš„ asyncio.ensure_future( get_request )



### await

- åœ¨åç¨‹ä¸­å¦‚æœè¦è°ƒç”¨å¦ä¸€ä¸ªåç¨‹å°±ä½¿ç”¨`await`ï¼Œå®ƒå¯ä»¥**æŒ‚èµ·é˜»å¡**çš„å¼‚æ­¥è°ƒç”¨æ¥å£ã€‚
  - **è¦æ³¨æ„awaitå…³é”®å­—è¦åœ¨asyncå®šä¹‰çš„å‡½æ•°ä¸­ä½¿ç”¨ï¼Œè€Œåè¿‡æ¥asyncå‡½æ•°å¯ä»¥ä¸å‡ºç°await**
- å¦‚æœä¸€ä¸ªå¯¹è±¡å¯ä»¥åœ¨ [`await`](https://docs.python.org/zh-cn/3/reference/expressions.html#await) è¯­å¥ä¸­ä½¿ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ **å¯ç­‰å¾…** å¯¹è±¡ã€‚è®¸å¤š asyncio API éƒ½è¢«è®¾è®¡ä¸ºæ¥å—å¯ç­‰å¾…å¯¹è±¡ã€‚
- <span style="color:red">å¯ç­‰å¾…</span> å¯¹è±¡æœ‰ä¸‰ç§ä¸»è¦ç±»å‹: **åç¨‹**, **ä»»åŠ¡** å’Œ **Future**.
  - å¦‚æœç›´æ¥ä½¿ç”¨ `await åç¨‹å‡½æ•°` ã€æ˜¯ä¸ä¼šæœ‰å¼‚æ­¥æ•ˆæœçš„ï¼Œç›¸å½“äºç”¨å¼‚æ­¥æ¥å£å†™äº†ä¸ªåŒæ­¥ä»£ç ã€‚éœ€è¦å°†åç¨‹å¯¹è±¡è½¬åŒ–æˆä»»åŠ¡æ‰å¯ä»¥å¼‚æ­¥è¿è¡Œã€‚
  - é€šè¿‡ `ensure_future` æˆ– `create_task` å‡½æ•°æ‰“åŒ…åç¨‹å¯¹è±¡å³å¯å¾—åˆ°**ä»»åŠ¡**ã€‚
  - [`Future`](https://docs.python.org/zh-cn/3/library/asyncio-future.html#asyncio.Future) æ˜¯ä¸€ç§ç‰¹æ®Šçš„ **ä½å±‚çº§** å¯ç­‰å¾…å¯¹è±¡ï¼Œè¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„ **æœ€ç»ˆç»“æœ**ã€‚
    - ä¸ç”¨å›è°ƒæ–¹æ³•ç¼–å†™å¼‚æ­¥ä»£ç åï¼Œä¸ºäº†è·å–å¼‚æ­¥è°ƒç”¨çš„ç»“æœï¼Œå¼•å…¥ä¸€ä¸ª Future æœªæ¥å¯¹è±¡ã€‚Future å°è£…äº†ä¸ loop çš„äº¤äº’è¡Œä¸ºï¼Œadd_done_callback æ–¹æ³•å‘ epoll æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œå½“ result å±æ€§å¾—åˆ°è¿”å›å€¼åï¼Œä¼šè¿è¡Œä¹‹å‰æ³¨å†Œçš„å›è°ƒå‡½æ•°ï¼Œå‘ä¸Šä¼ é€’ç»™ coroutineã€‚
    - é€šå¸¸æƒ…å†µä¸‹ **æ²¡æœ‰å¿…è¦** åœ¨åº”ç”¨å±‚çº§çš„ä»£ç ä¸­åˆ›å»º Future å¯¹è±¡

```python
import asyncio

async def producer():
    for i in range(1, 6):
        print(f'ç”Ÿäº§ï¼š{i}')
        await consumer(i)

async def consumer(i):
    print(f'æ¶ˆè´¹ï¼š{i}')

asyncio.run(producer())
# asyncio.run() æ˜¯py3.7æ›´æ–°å‡ºæ¥çš„ï¼Œåœ¨py3.7ä¸­ï¼Œä½¿ç”¨è¿™ä¸ªå¯ä»¥ç®€å•ç›´æ¥çš„è¿è¡Œ asyncio ç¨‹åºã€‚
```

- [`asyncio.run()`](https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.run) å‡½æ•°ç”¨æ¥è¿è¡Œæœ€é«˜å±‚çº§çš„å…¥å£ç‚¹ "main()" å‡½æ•°ï¼Œæ›´å¤šè§£é‡Šè¯¦è§ [å®˜æ–¹æ–‡æ¡£](https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.create_task)

- æ­¤å‡½æ•°æ€»æ˜¯ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº‹ä»¶å¾ªç¯å¹¶åœ¨ç»“æŸæ—¶å…³é—­ä¹‹ã€‚å®ƒåº”å½“è¢«ç”¨ä½œ asyncio ç¨‹åºçš„ä¸»å…¥å£ç‚¹ï¼Œç†æƒ³æƒ…å†µä¸‹åº”å½“åªè¢«è°ƒç”¨ä¸€æ¬¡ã€‚





## åç¨‹å¯¹è±¡

- *åç¨‹å¯¹è±¡*ï¼šè°ƒç”¨ *åç¨‹å‡½æ•°* æ‰€è¿”å›çš„å¯¹è±¡ã€‚
  - ç‰¹æ®Šå‡½æ•°è¢«è°ƒç”¨åï¼Œå‡½æ•°å†…éƒ¨çš„å®ç°è¯­å¥ä¸ä¼šè¢«ç«‹å³æ‰§è¡Œï¼Œç„¶åè¯¥å‡½æ•°è°ƒç”¨ä¼šè¿”å›ä¸€ä¸ªåç¨‹å¯¹è±¡ã€‚

- ç»“è®ºï¼šåç¨‹å¯¹è±¡ == ç‰¹æ®Šçš„å‡½æ•°è°ƒç”¨

```python
async def get_request(url):
    print("æ­£åœ¨è¯·æ±‚: ", url)
    sleep(1) # è¿™é‡Œæ˜¯ä¸ªå°å‘
    print('è¯·æ±‚ç»“æŸ:', url)

# å‡½æ•°è°ƒç”¨ï¼šè¿”å›çš„å°±æ˜¯ä¸€ä¸ªåç¨‹å¯¹è±¡
c = get_request('www.b.com')
print(c)	
	# <coroutine object get_request at 0x000002A6DFA026D0>

# åˆ›å»º3ä¸ªåç¨‹å¯¹è±¡
urls = [
    '1.com', '2.com', '3.com'
]
coroutine_list = []
for url in urls:
    c = get_request(url)
    coroutine_list.append(c)
print(coroutine_list)
	# [<coroutine object get_request at 0x0000022FE5313F10>, <coroutine object get_request at 0x0000022FE52426D0>, <coroutine object get_request at 0x0000022FE5313EB8>]
```



## ä»»åŠ¡å¯¹è±¡

- **ä»»åŠ¡å¯¹è±¡å…¶å®å°±æ˜¯å¯¹åç¨‹å¯¹è±¡çš„è¿›ä¸€æ­¥å°è£…**ã€‚
- *ä»»åŠ¡* è¢«ç”¨æ¥è®¾ç½®æ—¥ç¨‹ä»¥ä¾¿ *å¹¶å‘* æ‰§è¡Œåç¨‹ã€‚

ç»“è®ºï¼šä»»åŠ¡å¯¹è±¡ == é«˜çº§çš„åç¨‹å¯¹è±¡ == ç‰¹æ®Šçš„å‡½æ•°è°ƒç”¨

ç‰¹æ€§ï¼šå¯ä»¥ç»‘å®šå›è°ƒï¼ˆçˆ¬è™«ä¸­å›è°ƒå‡½æ•°å¸¸ç”¨æ¥åšæ•°æ®è§£æï¼‰



```python
import asyncio
from time import sleep

# åç¨‹å‡½æ•°çš„å®šä¹‰
async def get_request(url):
    print("æ­£åœ¨è¯·æ±‚: ", url)
    sleep(1)	# è¿™é‡Œæ˜¯ä¸ªå°å‘
    print('è¯·æ±‚ç»“æŸ:', url)


# å‡½æ•°è°ƒç”¨ï¼šè¿”å›çš„å°±æ˜¯ä¸€ä¸ªåç¨‹å¯¹è±¡
c = get_request('www.b.com')

# åˆ›å»ºä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼šåŸºäºåç¨‹å¯¹è±¡åˆ›å»ºçš„
task = asyncio.ensure_future(c)			# ensure_future æ˜¯py3.7ä¹‹å‰çš„

# åˆ›å»º3ä¸ªä»»åŠ¡å¯¹è±¡
urls = [
    '1.com', '2.com', '3.com'
]
task_list = []  # å­˜æ”¾å¤šä¸ªä»»åŠ¡å¯¹è±¡çš„åˆ—è¡¨
for url in urls:
    c = get_request(url)
    task = asyncio.ensure_future(c)
    task_list.append(task)
```



### ç»‘å®šå›è°ƒ

å›è°ƒå‡½æ•°ä»€ä¹ˆæ—¶å€™è¢«æ‰§è¡Œï¼Ÿ

- ä»»åŠ¡å¯¹è±¡æ‰§è¡Œç»“æŸåæ‰§è¡Œ

`task.add_done_callback(func)`

- funcå¿…é¡»è¦æœ‰ä¸€ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°è¡¨ç¤ºçš„æ˜¯è¯¥å›è°ƒå‡½æ•°å¯¹åº”çš„ä»»åŠ¡å¯¹è±¡
- `å›è°ƒå‡½æ•°çš„å‚æ•°.result()` ï¼š ä»»åŠ¡å¯¹è±¡å¯¹åº”çš„ç‰¹æ®Šå‡½æ•°æ‰§è¡Œç»“æŸçš„è¿”å›å€¼ã€‚



## äº‹ä»¶å¾ªç¯å¯¹è±¡

- ä½œç”¨ï¼šå°†å…¶å†…éƒ¨æ³¨å†Œçš„ä»»åŠ¡å¯¹è±¡è¿›è¡Œå¼‚æ­¥æ‰§è¡Œã€‚
- **äº‹ä»¶å¾ªç¯æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„åº•å±‚åŸºçŸ³**ã€‚
- åœ¨py3.6ä¸­æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åˆ›å»ºäº‹ä»¶å¾ªç¯å¯¹è±¡ã€‚
- åœ¨py3.7ä¸­ï¼Œæœ‰äº†é«˜å±‚çº§çš„ asyncio å‡½æ•°ï¼Œä¾‹å¦‚ asyncio.run()ï¼Œå°±å¾ˆå°‘æœ‰å¿…è¦ä½¿ç”¨ **ä½å±‚çº§å‡½æ•°** æ¥æ‰‹åŠ¨åˆ›å»ºå’Œå…³é—­äº‹ä»¶å¾ªç¯ã€‚

```python
import asyncio
import time


# å‡½æ•°çš„å®šä¹‰
# ä½¿ç”¨ async å…³é”®å­—ä¿®é¥°å‡½æ•°åï¼Œè°ƒç”¨è¯¥å‡½æ•°ï¼Œä½†ä¸ä¼šæ‰§è¡Œå‡½æ•°ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªcoroutineåç¨‹å¯¹è±¡
async def get_request(url):
    print("æ­£åœ¨è¯·æ±‚: ", url)
    # asyncio.sleep(1)    # é˜»å¡1sæ²¡æœ‰æˆåŠŸ
    await asyncio.sleep(1)  # åŠ ä¸Šawaitå…³é”®å­—å³å¯ï¼Œè¿™é‡Œçš„ await è¡¨ç¤ºç­‰å¾…
    print('è¯·æ±‚ç»“æŸ:', url)


# åˆ›å»º3ä¸ªåç¨‹å¯¹è±¡
urls = [
    '1.com', '2.com', '3.com'
]
start = time.time()


# py3.6
# åˆ›å»ºä»»åŠ¡åˆ—è¡¨ï¼šå­˜å‚¨å¤šä¸ªä»»åŠ¡å¯¹è±¡
tasks = [asyncio.ensure_future(get_request(url)) for url in urls]

# è·å–å½“å‰äº‹ä»¶å¾ªç¯ï¼Œå¦‚æœå½“å‰osçº¿ç¨‹æ²¡æœ‰è®¾ç½®å¹¶ä¸” set_event_loop() è¿˜æ²¡æœ‰è¢«è°ƒç”¨ï¼Œasyncioåˆ›å»ºä¸€ä¸ªæ–°çš„äº‹ä»¶å¾ªç¯
loop = asyncio.get_event_loop()
loop.run_until_complete(asyncio.wait(tasks))  # ç›´æ¥åˆ—è¡¨ä¼šæŠ¥é”™ï¼Œéœ€è¦ä¿®é¥°ä»¥ä¸‹ï¼Œè¿™é‡Œçš„ wait è¡¨ç¤ºæŒ‚èµ·

print('æ€»è€—æ—¶ï¼š', time.time() - start)

# py3.7

# å½“ç„¶è¿™æ ·çš„å†™æ³•ä»æ˜¯åŒæ­¥
# async def main():
#     for url in urls:
#         task = asyncio.create_task(get_request(url))
#         await task			# å½“å‰ä¹Ÿåªæœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œæ‰€ä»¥ä»æ˜¯åŒæ­¥
#     print('æ€»è€—æ—¶ï¼š', time.time() - start)
#
# asyncio.run(main())


# å¼‚æ­¥å†™æ³•ä¸€
# async def main():
#     tasks = [asyncio.create_task(get_request(url)) for url in urls]
#     for task in tasks:
#         await task              # è¿™æ ·å½“ä¸€ä¸ªä»»åŠ¡é‡åˆ°é˜»å¡å°±ä¼šåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼ŒçŸ¥é“æ‰€æœ‰ä»»åŠ¡éƒ½ç»“æŸä¸ºæ­¢
#     print('æ€»è€—æ—¶ï¼š', time.time() - start)
#
# asyncio.run(main())

# å¼‚æ­¥å†™æ³•äºŒï¼šæ¨è
# ä¸ºäº†çœå»éå†ä»»åŠ¡åˆ—è¡¨çš„è¿‡ç¨‹å¢åŠ äº† gather æ–¹æ³•
# async def main():
#     tasks = [asyncio.create_task(get_request(url)) for url in urls]
#     await asyncio.gather(*tasks)
#     print('æ€»è€—æ—¶ï¼š', time.time() - start)
# 
# asyncio.run(main())

```

- ä¸py3.6ç›¸æ¯”ï¼Œéƒ½æ˜¯å…ˆåšä¸€ä¸ªä»»åŠ¡åˆ—è¡¨ï¼Œç„¶åpy3.6éœ€è¦æ‰‹åŠ¨åˆ›å»ºäº‹ä»¶å¾ªç¯å¯¹è±¡`get_event_loop` å¹¶ä½¿ç”¨ `run_until_complete` æ¥è¾¾åˆ°å¼‚æ­¥æ‰§è¡Œï¼Œè€Œåœ¨py3.7ä¸­ï¼Œgatherä¼šå¹¶å‘çš„æ‰§è¡Œä¼ å…¥çš„å¯ç­‰å¾…å¯¹è±¡å¹¶åœ¨runçš„è°ƒç”¨ä¸‹å®Œæˆå¼‚æ­¥æ‰§è¡Œã€‚æ‰€ä»¥åœ¨æ–°ç‰ˆpy3.7ä¸­ï¼Œæˆ‘ä»¬æ— éœ€æ‰‹åŠ¨åˆ›å»ºå’Œå…³é—­äº‹ä»¶å¾ªç¯äº†ã€‚
- py3.7ç”¨ create_task ä»£æ›¿ ensure_futureã€‚



## ç¼–ç æµç¨‹

- å®šä¹‰åç¨‹å‡½æ•°
- åˆ›å»ºåç¨‹å¯¹è±¡
- å°è£…ä»»åŠ¡å¯¹è±¡
  - ç»‘å®šå›è°ƒå‡½æ•°
- åˆ›å»ºäº‹ä»¶å¾ªç¯å¯¹è±¡

- å°†ä»»åŠ¡å¯¹è±¡æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯å¯¹è±¡ä¸­ï¼Œå¹¶ä¸”å¼€å¯äº‹ä»¶å¾ªç¯ã€‚



æŒ‰ç…§æµç¨‹å®Œæ•´çš„py3.6ä»£ç å¦‚ä¸‹ï¼š

```python
import asyncio
import time


# å®šä¹‰åç¨‹å‡½æ•°
async def get_request(url):
    print("æ­£åœ¨è¯·æ±‚: ", url)
    # asyncio.sleep(1)    # é˜»å¡1sæ²¡æœ‰æˆåŠŸ
    await asyncio.sleep(1)  # åŠ ä¸Šawaitå…³é”®å­—å³å¯ï¼Œè¿™é‡Œçš„ await è¡¨ç¤ºç­‰å¾…
    print('è¯·æ±‚ç»“æŸ:', url)
    return 'æˆ‘å»å›è°ƒå•¦'


def parse(task):  # task è¡¨ç¤ºä¸å›è°ƒå‡½æ•°ç»‘å®šçš„ä»»åŠ¡å¯¹è±¡ / ç»™å›è°ƒå‡½æ•°ä¼ å…¥ä»»åŠ¡å¯¹è±¡
    print('i am task callback() !!!', task.result())


urls = [
    '1.com', '2.com', '3.com'
]
start = time.time()

# ä»»åŠ¡åˆ—è¡¨ï¼šå­˜å‚¨å¤šä¸ªä»»åŠ¡å¯¹è±¡
tasks = []
for url in urls:
    # åˆ›å»ºåç¨‹å¯¹è±¡
    c = get_request(url)
    # å°è£…ä»»åŠ¡å¯¹è±¡
    task = asyncio.ensure_future(c)
    # ç»‘å®šå›è°ƒ
    task.add_done_callback(parse)
    tasks.append(task)
# åˆ›å»ºäº‹ä»¶å¾ªç¯å¯¹è±¡
loop = asyncio.get_event_loop()
# å°†ä»»åŠ¡å¯¹è±¡æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯å¯¹è±¡ä¸­ï¼Œå¹¶ä¸”å¼€å¯äº‹ä»¶å¾ªç¯
loop.run_until_complete(asyncio.wait(tasks))  # ç›´æ¥åˆ—è¡¨ä¼šæŠ¥é”™ï¼Œéœ€è¦ä¿®é¥°ä»¥ä¸‹ï¼Œè¿™é‡Œçš„ wait è¡¨ç¤ºæŒ‚èµ·

print('æ€»è€—æ—¶ï¼š', time.time() - start)
```

noteï¼šåœ¨ç‰¹æ®Šå‡½æ•°å†…éƒ¨çš„å®ç°è¯­å¥ä¸­ä¸å¯ä»¥å‡ºç°ä¸æ”¯æŒå¼‚æ­¥çš„æ¨¡å—å¯¹åº”çš„ä»£ç ï¼Œå¦åˆ™å°±ä¼šç»ˆæ­¢å¤šä»»åŠ¡å¼‚æ­¥åç¨‹çš„å¼‚æ­¥æ•ˆæœã€‚



åœ¨py3.7ä¸­ï¼Œåˆ™ä¸º

- å®šä¹‰åç¨‹å‡½æ•°
- å®šä¹‰ asyncio ç¨‹åºçš„ä¸»å…¥å£
  - åˆ›å»ºåç¨‹å¯¹è±¡
  - å°è£…ä»»åŠ¡å¯¹è±¡
  - ç»‘å®šå›è°ƒå‡½æ•°

- `asyncio.run(main())`



æŒ‰ç…§æµç¨‹å®Œæ•´çš„py3.7ä»£ç å¦‚ä¸‹ï¼š

```python
import asyncio
import time


# å®šä¹‰åç¨‹å‡½æ•°
async def get_request(url):
    print("æ­£åœ¨è¯·æ±‚: ", url)
    await asyncio.sleep(1)
    print('è¯·æ±‚ç»“æŸ:', url)
    return 'æˆ‘å»å›è°ƒå•¦'


def parse(task):  # task è¡¨ç¤ºä¸å›è°ƒå‡½æ•°ç»‘å®šçš„ä»»åŠ¡å¯¹è±¡ / ç»™å›è°ƒå‡½æ•°ä¼ å…¥ä»»åŠ¡å¯¹è±¡
    print('i am task callback() !!!', task.result())


urls = [
    '1.com', '2.com', '3.com'
]
start = time.time()


# å®šä¹‰ asyncio ç¨‹åºçš„å…¥å£ç‚¹
async def main():
    tasks = []
    for url in urls:
        # åˆ›å»ºåç¨‹å¯¹è±¡
        c = get_request(url)
        # å°è£…ä»»åŠ¡å¯¹è±¡
        task = asyncio.create_task(c)
        # ç»‘å®šå›è°ƒå‡½æ•°
        task.add_done_callback(parse)
        tasks.append(task)
    await asyncio.gather(*tasks)
    print('æ€»è€—æ—¶ï¼š', time.time() - start)


asyncio.run(main())
```



## å¼‚æ­¥çš„æœ¬è´¨

- æŒ‰ç…§æ³¨å†Œé¡ºåºæ‰§è¡Œï¼Œé‡åˆ°é˜»å¡å°±ä¼šæŒ‚èµ·ï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚
- å½“ä¸Šä¸€ä¸ªä»»åŠ¡çš„é˜»å¡ç»“æŸåï¼Œå°±ä¼šç»§ç»­æ‰§è¡Œè¯¥ä»»åŠ¡ã€‚

- çœŸæ­£çš„æŒ‚èµ·æ˜¯ç”± `asyncio.wait(tasks)` åšåˆ°çš„



![äº‹ä»¶å¾ªç¯](å•çº¿ç¨‹-å¤šä»»åŠ¡çš„å¼‚æ­¥åç¨‹/äº‹ä»¶å¾ªç¯.jpg)

å›¾ç‰‡æ¥è‡ª: [è°ˆè°ˆPythonåç¨‹æŠ€æœ¯çš„æ¼”è¿›](https://zhuanlan.zhihu.com/p/30275154)



![åº•å±‚æµç¨‹](å•çº¿ç¨‹-å¤šä»»åŠ¡çš„å¼‚æ­¥åç¨‹/åº•å±‚æµç¨‹.png)

å›¾ç‰‡æ¥è‡ª [ç†è§£ Python asyncio](https://lotabout.me/2017/understand-python-asyncio/)



åº•å±‚è¿˜æ²¡æœ‰ç†è§£ï¼Œå…ˆæŠŠå¤§ä½¬çš„å›¾ç²˜è¿‡æ¥æ…¢æ…¢ç ”ç©¶ğŸ˜„



å¾…è¡¥å……ï¼ï¼ï¼



# æ€»ç»“

## æ‰§è¡Œåç¨‹çš„ä¸‰ç§æœºåˆ¶

asyncioæä¾›äº†ä¸‰ç§æ‰§è¡Œåç¨‹çš„æœºåˆ¶ï¼š

1. ä½¿ç”¨`asyncio.run()`æ‰§è¡Œåç¨‹ã€‚ä¸€èˆ¬ç”¨äºæ‰§è¡Œæœ€é¡¶å±‚çš„å…¥å£å‡½æ•°ï¼Œå¦‚`main()`ã€‚

2. `await`ä¸€ä¸ªåç¨‹ã€‚ä¸€èˆ¬ç”¨äºåœ¨ä¸€ä¸ªåç¨‹ä¸­è°ƒç”¨å¦ä¸€åç¨‹ã€‚

3. ç”¨ `asyncio.create_task()` æˆ– `asyncio.ensure_futuer()` æ–¹æ³•å°†Coroutineï¼ˆåç¨‹ï¼‰å°è£…ä¸ºTaskï¼ˆä»»åŠ¡ï¼‰ã€‚ä¸€èˆ¬ç”¨äºå®ç°å¼‚æ­¥å¹¶å‘æ“ä½œã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåªæœ‰åœ¨å½“å‰çº¿ç¨‹å­˜åœ¨äº‹ä»¶å¾ªç¯çš„æ—¶å€™æ‰èƒ½åˆ›å»ºä»»åŠ¡ï¼ˆTaskï¼‰ã€‚

   

åœ¨ä¸‹ä¸€ç¯‡ä¸­å°†ç»“åˆ aiohttp ç½‘ç»œè¯·æ±‚æ¨¡å—ï¼ŒåŠ é€Ÿçˆ¬å–ï¼ï¼ï¼